---
title: 'Studying the effect of caffeine on pulse rate'
author: "S. Sudhir"
date: "2023-05-11"
output: github_document
---

```{r setup, include=FALSE}
#setwd("~/Documents/University of Wisconsin Madison /Undergraduate/Semester 4/Statistical Experimental Design/Project")

knitr::opts_chunk$set(fig.width = 6, fig.height = 4) 

library(readr)
library(reactable)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(multcomp)
library(DescTools)
library(sjPlot)
library(reshape2)    
library(multcomp)

matrix_1 <- matrix(c(1,2,3,4), nrow = 2, ncol = 2)
matrix_2 <- matrix(c(1,2), nrow = 1, ncol = 2)
```

# Introduction

I am interested in conducting a rigorous statistical analysis to study how caffeine affects pulse rate. In order to conduct this experiment, I chose three of my friends as participants and had them consume 50 mg, 100 mg, and 200 mg caffeine pills on separate days and then recorded the change in average pulse rate before and after the consumption of each caffeine pill. It is well-studied in papers like [Gonzaga LA et al.](https://www.nature.com/articles/s41598-017-14540-4) and [Karapetian GK et al.](https://pubmed.ncbi.nlm.nih.gov/22499570/) that caffeine is attributed to a subsequent decrease in pulse rate. This research however studies the effect of caffeine on decrease in pulse rate specifically based on quantity of caffeine consumed (50 mg, 100 mg, and 200 mg).

# Experimental Design

I chose a 3-by-3 Latin Square Design for this experiment with the following parameters:

* **`Day` [blocking]:** 
  * 1: 04/24/2023
  * 2: 04/25/2023
  * 3: 04/26/2023

\vspace{1.5cm}

* **`Participant` [blocking]:** 
  * 1: age - 21, sex - female
  * 2: age - 20, sex - male
  * 3: age - 21, sex - male

\vspace{1.5cm}

* **`Caffeine` [treatment]:** 
  * A: $50$ mg 
  * B: $100$ mg 
  * C: $200$ mg.

\vspace{1.5cm}

* **`Decrease` $y_{ijk}$ [response]:**
  * $i:$ `Day`, i.e., $i = 1,2,3$
  * $j:$ `Participant`, i.e., $j = 1,2,3$ 
  * $k:$ `Caffeine`, i.e., $k = A, B, C$

## Advantages of Design

1. Allows us to block two nuisance variables we wish to keep separate (`Day` and `Participant`).

2. Permits us to study $3$ treatments simultaneously, with $2$ blocking variables, each at $3$ levels, i.e., test each caffeine pill $(k)$, once on each participant $(j)$, and on each day $(i)$.

3. Only 9 number of runs required, making our experiment both time and cost effective.

## Shortcomings of Design

1. The number of levels of each blocking variable must be the same as the levels of treatment factor. As two of my participants are male, and one is female, the design does not allow us to block the confounding effect of gender.

2. The experiment was not conducted in a controlled setting, any underlying confounding effects could not be controlled (such as the time of day at which a caffeine pill was consumed).

3. Due to the non-replication nature of the design, no interaction effect between treatment and blocking variable can be studied.

# Setting Up Design

After randomizing experimental participants, along with the day, and capsule consumption, the design used for this experiment is given below:

```{r, echo = F, comment = NA}
design = matrix(c('A (y_11A)', 'C (y_12C)', 'B (y_13B)',
                  'B (y_21B)', 'A (y_22A)', 'C (y_23C)',
                  'C (y_31C)', 'B (y_32B)', 'A (y_33A)'), nrow = 3, ncol = 3, byrow = T)

colnames(design) = c('Participant 1', 'Participant 2', 'Participant 3')
design
```

The interpretation of the matrix is as follows:

* **Day 1 [04/24/2023]:** 

  * Participant 1 takes 50 mg caffeine pill, i.e., $\mathbf{y_{11A}}$.
  * Participant 2 takes 200 mg caffeine pill, i.e., $\mathbf{y_{12C}}$.
  * Participant 3 takes 100 mg caffeine pill, i.e., $\mathbf{y_{13B}}$. 
  
\vspace{1.5cm}

* **Day 2 [04/25/2023]:** 

  * Participant 1 takes 100 mg caffeine pill, i.e., $\mathbf{y_{21B}}$.
  * Participant 2 takes 50 mg caffeine pill, i.e., $\mathbf{y_{22A}}$.
  * Participant 3 takes 200 mg caffeine pill, i.e., $\mathbf{y_{23C}}$.

\vspace{1.5cm}

* **Day 3 [04/26/2023]:** 

  * Participant 1 takes 200 mg caffeine pill, i.e., $\mathbf{y_{31C}}$.
  * Participant 2 takes 100 mg caffeine pill, i.e., $\mathbf{y_{32B}}$.
  * Participant 3 takes 50 mg caffeine pill, i.e., $\mathbf{y_{33A}}$.

# Apparatus Used

To administer caffeine pills, I bought the [Nutricost Caffeine Pills](https://www.amazon.com/dp/B01MY5CW7S?ref=ppx_yo2ov_dt_b_product_details&th=1) 100 mg per serving, 250 capsules bottle. 

* For 50 mg (A) caffeine, I administered half a capsule. 

* For 100 mg (B) caffeine, I administered one entire capsule. 

* For 200 mg (C), I administered two capsules.

To measure pulse rate, I used the [EMAY Bluetooth Pulse Oximeter Fingertip](https://www.amazon.com/dp/B08FFHG69C?psc=1&ref=ppx_yo2ov_dt_b_product_details).

* For initial measurements, I used the Oximeter for five minutes and recorded the data.

* I then administered the designated dosage of caffeine pill, waited for approximately 45 minutes, then re-took measurements for 5 minutes and recorded the data.



# Data Collected
## Day 1 
### Participant 1 [50 mg]

```{r, echo = F}
Day_1_Participant_A_night_initial <- read.csv('Day_1_Participant_A_night_initial.csv')
Day_1_Participant_A_night_initial <- na.omit(Day_1_Participant_A_night_initial)
Day_1_Participant_A_night_initial <- Day_1_Participant_A_night_initial[c(-301), ]

Day_1_Participant_A_night_final <- read.csv('Day_1_Participant_A_night_final.csv')
Day_1_Participant_A_night_final <- na.omit(Day_1_Participant_A_night_final)

data_11 = data.frame(seq(1:300), Day_1_Participant_A_night_initial$PR.bpm., Day_1_Participant_A_night_final$PR.bpm.)

colnames(data_11) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_11, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_11, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_11, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```


```{r, echo = F, comment = NA}
Day_1_A_night = mean(data_11$`Initial BPM`) - mean(data_11$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 50 mg pill for Participant 1 is ', round(Day_1_A_night, 3), ' (y_11A)')
```

### Participant 2 [200 mg]

```{r, echo = F}
Day_1_Participant_B_afternoon_initial <- read.csv('Day_1_Participant_B_afternoon_initial.csv')
Day_1_Participant_B_afternoon_initial <- na.omit(Day_1_Participant_B_afternoon_initial)
Day_1_Participant_B_afternoon_initial <- Day_1_Participant_B_afternoon_initial[c(-304:-301), ]

Day_1_Participant_B_afternoon_final <- read.csv('Day_1_Participant_B_afternoon_final.csv')
Day_1_Participant_B_afternoon_final <- na.omit(Day_1_Participant_B_afternoon_final)
Day_1_Participant_B_afternoon_final <- Day_1_Participant_B_afternoon_final[c(-307:-301), ]

data_12 = data.frame(seq(1:300), Day_1_Participant_B_afternoon_initial$PR.bpm., Day_1_Participant_B_afternoon_final$PR.bpm.)

colnames(data_12) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_12, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_12, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_12, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```


```{r, echo = F, comment = NA}
Day_1_B_after = mean(data_12$`Initial BPM`) - mean(data_12$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 200 mg pill for Participant 2 is ', round(Day_1_B_after, 3), ' (y_12C)')
```

### Participant 3 [100 mg]

```{r, echo = F}
Day_1_Participant_C_morning_initial <- read.csv('Day_1_Participant_C_morning_initial.csv')
Day_1_Participant_C_morning_initial <- na.omit(Day_1_Participant_C_morning_initial)
Day_1_Participant_C_morning_initial <- Day_1_Participant_C_morning_initial[c(-1,-303,-302), ]

Day_1_Participant_C_morning_final <- read.csv('Day_1_Participant_C_morning_final.csv')
Day_1_Participant_C_morning_final <- na.omit(Day_1_Participant_C_morning_final)
Day_1_Participant_C_morning_final <- Day_1_Participant_C_morning_final[c(-301), ]

data_13 = data.frame(seq(1:300), Day_1_Participant_C_morning_initial$PR.bpm., Day_1_Participant_C_morning_final$PR.bpm.)

colnames(data_13) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_13, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_13, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_13, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```


```{r, echo = F, comment = NA}
Day_1_C_morn = mean(data_13$`Initial BPM`) - mean(data_13$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 100 mg caffeine pill for Participant 3 is ', round(Day_1_C_morn, 3), ' (y_13B)')
```


**Visualizing Data for Day 1**

```{r,echo = F, message = F}
day_1_merge <- data.frame(c(rep('initial', 300), 
                            rep('final', 300)), 
                          c(data_11$`Initial BPM`, 
                            data_11$`Final BPM`), 
                          c(data_12$`Initial BPM`, 
                            data_12$`Final BPM`), 
                          c(data_13$`Initial BPM`, 
                            data_13$`Final BPM`))

colnames(day_1_merge) <- c('Initial vs Final', '1', '2', '3')

melt(day_1_merge) %>%
  ggplot(aes(x = variable, y = value, fill = `Initial vs Final`)) +
  geom_boxplot() +
    theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
    xlab("Participant") +
    ylab("Pulse Rate (beats per minute)")
```


## Day 2 
### Participant 1 [100 mg]

```{r, echo = F}
Day_2_Participant_A_afternoon_initial <- read.csv('Day_2_Participant_A_afternoon_initial.csv')
Day_2_Participant_A_afternoon_initial <- na.omit(Day_2_Participant_A_afternoon_initial)
Day_2_Participant_A_afternoon_initial <- Day_2_Participant_A_afternoon_initial[c(-325:-301), ]


Day_2_Participant_A_afternoon_final <- read.csv('Day_2_Participant_A_afternoon_final.csv')
Day_2_Participant_A_afternoon_final <- na.omit(Day_2_Participant_A_afternoon_final)
Day_2_Participant_A_afternoon_final <- Day_2_Participant_A_afternoon_final[c(-301), ]

data_21 = data.frame(seq(1:300), Day_2_Participant_A_afternoon_initial$PR.bpm., Day_2_Participant_A_afternoon_final$PR.bpm.)

colnames(data_21) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_21, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_21, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_21, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_2_A_after = mean(data_21$`Initial BPM`) - mean(data_21$`Final BPM`)
paste0('The difference in average pulse rate before and after consumption of 100 mg pill in the afternoon for Participant 1 is ', round(Day_2_A_after, 3), ' (y_21B)')
```


### Participant 2 [50 mg]

```{r, echo = F}
Day_2_Participant_B_morning_initial <- read.csv('Day_2_Participant_B_morning_initial.csv')
Day_2_Participant_B_morning_initial <- na.omit(Day_2_Participant_B_morning_initial)
Day_2_Participant_B_morning_initial <- Day_2_Participant_B_morning_initial[c(-304:-301), ]

Day_2_Participant_B_morning_final <- read.csv('Day_2_Participant_B_morning_final.csv')
Day_2_Participant_B_morning_final <- na.omit(Day_2_Participant_B_morning_final)
Day_2_Participant_B_morning_final <- Day_2_Participant_B_morning_final[c(-302:-301), ]

data_22 = data.frame(seq(1:300), Day_2_Participant_B_morning_initial$PR.bpm., Day_2_Participant_B_morning_final$PR.bpm.)

colnames(data_22) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_22, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_22, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_22, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_2_B_morn = mean(data_22$`Initial BPM`) - mean(data_22$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 50 mg pill for Participant 2 is ', round(Day_2_B_morn, 3), ' (y_22A)')
```

### Participant 3 [200 mg]

```{r, echo = F}
Day_2_Participant_C_night_initial <- read.csv('Day_2_Participant_C_night_initial.csv')
Day_2_Participant_C_night_initial <- na.omit(Day_2_Participant_C_night_initial)
Day_2_Participant_C_night_initial <- Day_2_Participant_C_night_initial[c(-305:-301), ]


Day_2_Participant_C_night_final <- read.csv('Day_2_Participant_C_night_final.csv')
Day_2_Participant_C_night_final <- na.omit(Day_2_Participant_C_night_final)


data_23 = data.frame(seq(1:300), Day_2_Participant_C_night_initial$PR.bpm., c(Day_2_Participant_C_night_final$PR.bpm., rep(60, 6)))

colnames(data_23) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_23, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_23, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_23, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_2_C_night = mean(data_23$`Initial BPM`) - mean(data_23$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 200 mg pill for Participant 3 is ', round(Day_2_C_night, 3), ' (y_23C)')
```

**Visualizing Data for Day 2**

```{r,echo = F, message = F}
day_1_merge <- data.frame(c(rep('initial', 300), 
                            rep('final', 300)), 
                          c(data_21$`Initial BPM`, 
                            data_21$`Final BPM`), 
                          c(data_22$`Initial BPM`, 
                            data_22$`Final BPM`), 
                          c(data_23$`Initial BPM`, 
                            data_23$`Final BPM`))

colnames(day_1_merge) <- c('IF', '1', '2', '3')

melt(day_1_merge) %>%
  ggplot(aes(x = variable, y = value, fill = IF)) +
  geom_boxplot() +
    theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
    xlab("Participant") +
    ylab("Pulse Rate (beats per minute)")
```

## Day 3 
### Participant 1 [200 mg]

```{r, echo = F}
Day_3_Participant_A_morning_initial <- read.csv('Day_3_Participant_A_morning_initial.csv')
Day_3_Participant_A_morning_initial <- na.omit(Day_3_Participant_A_morning_initial)
Day_3_Participant_A_morning_initial <- Day_3_Participant_A_morning_initial[c(-302:-301), ]

Day_3_Participant_A_morning_final <- read.csv('Day_3_Participant_A_morning_final.csv')
Day_3_Participant_A_morning_final <- na.omit(Day_3_Participant_A_morning_final)
Day_3_Participant_A_morning_final <- Day_3_Participant_A_morning_final[c(-313:-301), ]

data_31 = data.frame(seq(1:300), Day_3_Participant_A_morning_initial$PR.bpm., Day_3_Participant_A_morning_final$PR.bpm.)

colnames(data_31) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_31, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_31, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_31, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_3_A_morn = mean(data_31$`Initial BPM`) - mean(data_31$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 200 mg pill for Participant 1 is ', round(Day_3_A_morn, 3), ' (y_31C)')
```

### Participant 2 [100 mg]

```{r, echo = F}
Day_3_Participant_B_night_initial <- read.csv('Day_3_Participant_B_night_initial.csv')
Day_3_Participant_B_night_initial <- na.omit(Day_3_Participant_B_night_initial)
Day_3_Participant_B_night_initial <- Day_3_Participant_B_night_initial[c(-307:-301), ]


Day_3_Participant_B_night_final <- read.csv('Day_3_Participant_B_night_final.csv')
Day_3_Participant_B_night_final <- na.omit(Day_3_Participant_B_night_final)
Day_3_Participant_B_night_final <- Day_3_Participant_B_night_final[c(-310:-301), ]


data_32 = data.frame(seq(1:300), Day_3_Participant_B_night_initial$PR.bpm., Day_3_Participant_B_night_final$PR.bpm.)

colnames(data_32) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_32, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_32, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_32, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_3_B_night = mean(data_32$`Initial BPM`) - mean(data_32$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 100 mg pill for Participant 2 is ', round(Day_3_B_night, 3), ' (y_32B)')
```

### Participant 3 [50 mg]

```{r, echo = F}
Day_3_Participant_C_afternoon_initial <- read.csv('Day_3_Participant_C_afternoon_initial.csv')
Day_3_Participant_C_afternoon_initial <- na.omit(Day_3_Participant_C_afternoon_initial)
Day_3_Participant_C_afternoon_initial <- Day_3_Participant_C_afternoon_initial[c(-301), ]

Day_3_Participant_C_afternoon_final <- read.csv('Day_3_Participant_C_afternoon_final.csv')
Day_3_Participant_C_afternoon_final <- na.omit(Day_3_Participant_C_afternoon_final)
Day_3_Participant_C_afternoon_final <- Day_3_Participant_C_afternoon_final[c(-302:-301), ]

data_33 = data.frame(seq(1:300), Day_3_Participant_C_afternoon_initial$PR.bpm., Day_3_Participant_C_afternoon_final$PR.bpm.)

colnames(data_33) <- c('Time (in seconds)', 'Initial BPM', 'Final BPM')
```

```{r, echo = F}
ggplot(data = data_33, aes(x = `Time (in seconds)`, y = `Initial BPM`)) +
  
  ## Plotting original avg.temp
  geom_line(data = data_33, 
            aes(x = `Time (in seconds)`, 
                y = `Initial BPM`, 
                color = "Initial BPM")) +
  
  ## Plotting exponential smoothing
  geom_line(data = data_33, 
            aes(x = `Time (in seconds)`, 
                y = `Final BPM`, 
                color = "Final BPM")) +
  
  ## Adding Legend
  scale_color_manual("Legend", breaks = c("Initial BPM",
                                          "Final BPM"),
                                values = c("#00BFC4", 
                                           "#F8766D")) +
  
  ## Creating Titles for main, x-axis, and y-axis
  xlab('Time (in seconds)') + 
  ylab('Pulse Rate (BPM)') + 
  
  ## Setting theme
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"))
```

```{r, echo = F, comment = NA}
Day_3_C_after = mean(data_33$`Initial BPM`) - mean(data_33$`Final BPM`)
paste0('The difference in average pulse rate before and after consuming 50 mg pill for Participant 3 is ', round(Day_3_C_after, 3), ' (y_33A)')
```


**Visualizing Data for Day 3**

```{r,echo = F, message = F}
day_3_merge <- data.frame(c(rep('initial', 300), 
                            rep('final', 300)), 
                          c(data_31$`Initial BPM`, 
                            data_31$`Final BPM`), 
                          c(data_32$`Initial BPM`, 
                            data_32$`Final BPM`), 
                          c(data_33$`Initial BPM`, 
                            data_33$`Final BPM`))

colnames(day_3_merge) <- c('IF', '1', '2', '3')

melt(day_3_merge) %>%
  ggplot(aes(x = variable, y = value, fill = IF)) +
  geom_boxplot() +
    theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
    xlab("Participant") +
    ylab("Pulse Rate (beats per minute)")
```

# Data Table

```{r, echo = F, comment = NA}
design = matrix(c('A (8.997)', 'C (12.323)', 'B (8.193)',
                  'B (10.043)', 'A (9.667)', 'C (8.547)',
                  'C (14.547)', 'B (15.6)', 'A (9.997)'), nrow = 3, ncol = 3, byrow = T)

colnames(design) = c('Participant 1', 'Participant 2', 'Participant 3')
rownames(design) = c('Day 1', 'Day 2', 'Day 3')
design

data = matrix(c(1, 2, 3, 1, 2, 3, 1, 2, 3,
                1, 1, 1, 2, 2, 2, 3, 3, 3,
                'A', 'C', 'B', 'B', 'A', 'C', 'C', 'B', 'A',
                8.997, 12.323, 8.193, 10.043, 9.667, 8.547, 14.547, 15.6, 9.997), nrow = 9, ncol = 4)

colnames(data) = c('Participant', 'Day', 'Caffeine', 'Decrease')
data = data.frame(data)
data$Participant = as.factor(data$Participant)
data$Day = as.factor(data$Day)
data$Caffeine = as.factor(data$Caffeine)
data$Decrease = as.numeric(data$Decrease)
data
```

# Analysis of Variance [ANOVA]
## Linear Model for Latin Square Design

The linear model for our Latin Square Design is as follows:

$$
y_{ijk} = \eta + \alpha_i + \beta_j + \tau_k + \epsilon_{ijk}
$$

where: 

* $\eta$ is the grand mean.

* $\alpha_i$ is the i-th row effect [`Day`]

* $\beta_j$ is the j-th column effect [`Participant`]

* $\tau_k$ is the k-th treatment effect of the letters ($A,B,C$) [`Caffeine`]

* $\epsilon_{ijk}$ are independent $N(0,\sigma^2)$.

There are no interaction terms as they cannot be estimated in an un-replicated experiment.

Using the zero-sum constraints, we have that:

$$
y_{ijk} = \hat{\eta} + \hat{\alpha}_i + \hat{\beta}_j + \hat{\tau}_k + r_{ijk}
$$

where:

* $\hat\eta = \bar{y}_{....}$

* $\hat{\alpha}_i = (\bar{y}_{i..} - \bar{y}_{...})$

* $\hat{\beta}_j = (\bar{y}_{.j.} - \bar{y}_{...})$

* $\hat{\tau}_k = (\bar{y}_{..k} - \bar{y}_{...})$

* $\hat{r}_{ijk} = (y_{ijk} - \bar{y}_{i..} - \bar{y}_{.j.} - \bar{y}_{..k} + 2 \bar{y}_{...})$

Then, subtracting $\bar{y}_{...}$, squaring both sides, and summing over all observations, we have that:

$$
\underbrace{\displaystyle\sum_{(i,j,k) \in S} (y_{ijk} - \bar{y}_{...})^2}_{SSE_{total}}
 =\underbrace{\displaystyle\sum_{i \in \{1,2,3\}} 3(\bar{y}_{i..} - \bar{y}_{...})^2}_{SSE_{row}} + \underbrace{\displaystyle\sum_{j \in \{1,2,3\}} 3(\bar{y}_{.j.} - \bar{y}_{...})^2}_{SSE_{column}} + \underbrace{\displaystyle\sum_{k \in \{A,B,C\}} 3(\bar{y}_{..k} - \bar{y}_{...})^2}_{SSE_{treatment}} + \underbrace{\displaystyle\sum_{(i,j,k) \in S} (y_{ijk} - \bar{y}_{i..} - \bar{y}_{.j.} - \bar{y}_{..k} + 2 \bar{y}_{...})^2}_{SSE_{residual}}
$$

where the set of $3^2$ values dictated by the particular Latin square triplets $(i,j,k)$ is denoted by $S$.

The above derivation tells us that the corrected total sum of squares on the left equals the sum of the row sum of squares, column sum of squares, treatment sum of squares, and residual sum of squares.

## Code for ANOVA Table Latin Square Design

```{r}
## Degrees of Freedom
n = 3
df_row = n-1
df_col = n-1
df_treat = n-1
df_resid = (n-1)*(n-2)

## Grand mean
y_... = mean(data$Decrease)  

## Row Effects [Day]
y_i.. = c(mean(data[which(data$Participant == '1'), ]$Decrease), 
          mean(data[which(data$Participant == '2'), ]$Decrease), 
          mean(data[which(data$Participant == '3'), ]$Decrease))
SSE_row = n*sum((y_i.. - y_...)^2)
MSE_row = SSE_row/df_row

## Column Effects [Participant]
y_.j. = c(mean(data[which(data$Day == '1'), ]$Decrease), 
          mean(data[which(data$Day == '2'), ]$Decrease), 
          mean(data[which(data$Day == '3'), ]$Decrease))
SSE_col = n*sum((y_.j. - y_...)^2)
MSE_col = SSE_col/df_col

## Treatment Effects [Caffeine]
y_..k = c(mean(data[which(data$Caffeine == 'A'), ]$Decrease),
          mean(data[which(data$Caffeine == 'B'), ]$Decrease),
          mean(data[which(data$Caffeine == 'C'), ]$Decrease))
SSE_treat = n*sum((y_..k - y_...)^2)
MSE_treat = SSE_treat/df_treat

## Residuals
SSE_resid = sum((data$Decrease - y_...)^2) - SSE_row - SSE_col - SSE_treat
MSE_resid = SSE_resid/df_resid

## F-values
F_row = MSE_row/MSE_resid
F_col = MSE_col/MSE_resid
F_treat = MSE_treat/MSE_resid

## P-value
Pval_row = 1 - pf(F_row, 2, 2)
Pval_col = 1 - pf(F_col, 2, 2)
Pval_treat = 1 - pf(F_treat, 2, 2)
```

**ANOVA Table:**

```{r, echo = F}
matrix = matrix(c('Day', 'Participant', 'Caffeine', 'Residuals', 'Totals',
           df_row, df_col, df_treat, df_resid, df_row + df_col + df_treat + df_resid,
           round(SSE_row, 3), round(SSE_col, 3), round(SSE_treat, 3), round(SSE_resid, 3), round(SSE_row + SSE_col + SSE_treat + SSE_treat + SSE_resid, 3),
           round(MSE_row, 3), round(MSE_col, 3), round(MSE_treat, 3), round(MSE_resid, 3), round(MSE_row + MSE_col + MSE_treat + MSE_resid, 3),
           round(F_row, 3), round(F_col, 3), round(F_treat, 3), '', '',
           round(Pval_row, 3), round(Pval_col, 3), round(Pval_treat, 3), '', ''), nrow = 5, ncol = 6)
colnames(matrix) = c('Source', 'Df', 'SSE', 'MSE', 'F', 'pval')
data.frame(matrix)
```

## Analysis of Latin Square Design ANOVA Table

The null hypothesis of our model is that there are no treatment effect differences, i.e.,

$$
H_0: \tau_i = \tau_j\;\;for\;all\;i,j \in \{A,B,C\}
$$

The alternative hypothesis of our model is that there is at least one treatment effect difference, i.e., 

$$
H_1: \tau_i \neq \tau_j\;\;for\;some\;i,j \in \{A,B.C\}
$$

Given the degrees of freedom $n - 1 = 3-1 = 2$ and $(n-1)(n-2) = (2)(1) = 2$, along with following F-values:

1. F-statistic = 19 (coral)
2. F-value [`Day`] = 156.471 (navyblue)
3. F-value [`Participant`] = 221.453 (limegreen)
4. F-value [`Caffeine`] = 64.865 (purple)

```{r, echo = F}
ggplot(data.frame(x = c(0, 250)), aes(x)) +
  stat_function(fun = df,
                geom = "line",
                args = list(df1 = 2, df2 = 2)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_vline(xintercept = F_row, col = 'skyblue') +
  geom_vline(xintercept = F_col, col = 'limegreen') +
  geom_vline(xintercept = F_treat, col = 'purple') +
  geom_vline(xintercept = qf(0.95, 2, 2), col = 'coral') +
  xlab('F-score') +
  ylab('') +
  ggtitle('F-distribution (df: 2 and 2)')
```

We can see that both our blocking factors [`Day` and `Participants`] are statistically significant, i.e., null hypothesis rejected as p-value < 0.05. This implies that even upon taking into account the effects of Day and Participant on decrease in pulse rate after consuming caffeine pill, those variables seem to have a significant effect on our analysis. 

More importantly, we can see that the p-value of treatment factor `Caffeine` is also lesser than 0.05, but greater than 0.01. This could imply that among the three levels of the treatment factor, at least one pair of group means is not significant. In order to study this, we conduct a Tukey Multiple-Comparisons 95% family-wise confidence level test. 

## Tukey Multiple-Comparisons for ANOVA

```{r}
require(multcomp)
Tukey_posthoc = confint(glht(lm(Decrease ~ Day + Participant + Caffeine, data), linfct = mcp(Caffeine = 'Tukey')))
Tukey_posthoc
```

```{r, echo = F}
plot(Tukey_posthoc)
```


We can see that the paired-groups B-A [100 mg caffeine vs 50 mg caffeine] and groups C-A [200 mg caffeine vs 50 mg caffeine] are statistically significant. However, the paired-group C-B [200 mg vs 100 caffeine] is not statistically significant. This could imply that the effects of caffeine on pulse rate is most significant when taking over 50 mg, not when taking over 100 mg or 200 mg.

## Visual Interpretation of Inference

Given below is a summary table of our treatment factor group `Caffeine` and its corresponding means and sd in relation to `Decrease`.

```{r, echo = F, message = F, warning = F}
A = c(Day_1_A_night, Day_2_B_morn, Day_3_C_after) # 50 mg
B = c(Day_1_C_morn, Day_2_A_after, Day_3_B_night) # 100 mg
C = c(Day_1_B_after, Day_2_C_night, Day_3_A_morn) # 200 mg
pulp_exp <- data.frame( 
                group = rep(c("A", "B", "C"), each = 3),
                decrease = c(A, B, C)
                )

group_by(pulp_exp, group) %>%
  summarise(
    count = n(),
    mean = mean(decrease, na.rm = TRUE),
    sd = sd(decrease, na.rm = TRUE)
  )
```

Given below is a 2d line plot where the x-axis is our treatment factor `Caffeine` and y-axis is our response `Decrease`. This plot allows us to see how the three levels of caffeine quantity affects response.

```{r, echo = F, message = F, warning = F}
ggline(pulp_exp, x = "group", 
                 y = "decrease",
          add = c("mean_se", "jitter"),
          color = "group", 
          palette = c("#A020F0", "#E7B800", "#FC4E07"),
          order = c("A", "B", "C"),
          ylab = "decrease in BPM",   
          xlab = "Caffeine [A: 50 mg, B: 100 mg, C: 200 mg]")+ 
  stat_summary(fun.y=mean, 
               colour="black", 
               linetype = 'dashed', 
               geom = "line", 
               aes(group = 1))
```

Given below is a 3d interactive scatter plot where the x-axis is our row blocking factor `Day`, y-axis is our column blocking factor `Participant`, and z-axis is our response `Decrease`. This plot allows us to see how the two blocking factors affect our response. 

```{r, message = F, echo = F, warning = F}
library(plotly)
fig <- plot_ly(data, x = ~as.numeric(Participant), y = ~as.numeric(Day), z = ~Decrease, color = ~Caffeine, colors = c("#A020F0", "#E7B800", "#FC4E07"))
fig <- fig %>% add_markers()

fig <- fig %>% layout(scene = list(xaxis = list(title = 'Participant'),
                     yaxis = list(title = 'Day'),
                     zaxis = list(title = 'Decrease')))

fig
```


# Conclusion

A 3-by-3 Latin Square Design was chosen to conduct this experiment with factors: `Day`, `Participants`, `Caffeine`, and `Decrease`. The blockedc nuisance factors were `Day` and `Participants`, the treatment factor to be studied was `Caffeine` and the response variable was `Decrease`. After randomizing the factors and setting up the design, pulse rate measurements were taken before and after consumption of assigned caffeine pill, and the difference in average pulse rates were recorded. After $9$ trials, wherein each of the three participant consumed each of the three pills on each separate day, an ANOVA was conducted for Latin Square Design using the Sum Squared and Mean Squared errors for each factor group.

The ANOVA found that there is a statistical significance between the quantity of caffeine consumed and the subsequent decrease in heart rate. In particular, there seems to be a statistical significance between 50 mg - 100 mg caffeine group and 50 mg - 200 mg caffeine group. This can also be confirmed visually as we can see that the mean of 50 mg caffeine group is significantly lower than the mean of 100 mg and 200 mg caffeine group. Additionally, the mean of 100 mg and 200 mg caffeine groups were relatively the same, and no statistical significance was found between them. It was also found that even after blocking, the variables `Day` and `Participants` were both statistically significant. This would imply that there are significant effects between the blocking variable and response, however due to non-replication of the experiment, the interaction effects could not be studied.  Furthermore, The variance of treatment group A is much lesser than the variance of treatment group B and C, which suggests that variance between groups is constant. Both these issues could be fixed with replication, unfortunately due to time and cost constraints, no replication was conducted for this experiment.

Due to the nature of the design, only two nuisance factors could be blocked: the day in which caffeine was consumed and the participant who consumed the caffeine. My intuition for blocking these two variables were that, tolerance would increase each day of caffeine consumption, and the prior tolerances of each candidate could significantly affect readings of pulse rate. That said, there were some very important confounding variables that could not be blocked. For one, the time of day at which the caffeine pill was consumed was a primary factor I wished to block using a 3-by-3 Graeco-Squared design for the experiment, but unfortunately no degrees of freedom were left after estimating factorial effects. Additionally, the sex of the candidates could also not be blocked as a Latin-Square design requires that the blocking factors have the same levels as treatment factors, which is not the case here. Lastly, the experiment could not be conducted in a controlled setting. Although I had asked the participants to refrain from consuming any caffeine for the three days the experiment had to be done, there was no way of knowing if they truly adhered to the instructions. Furthermore, I had to record their readings in stressful environments like the library or a cafe, which could have further impeded the reading as a result. 

Although the results of the experiment were interesting (it might be jarring to know that effect of caffeine pills on pulse rate is significant for only 50+ mg pills, but not so much for 100+ and 200+ caffeine pills), it must be noted that there are significant effects from other extraneous factors that randomization and blocking could not negate. A good followup to this experiment would be to conduct one where multiple factors could be blocked by the use of a 4-by-4 or 5-by-5 Hyper-Graeco Latin Square Design or a 3^k factorial design (or fractional factorial depending on the resources available). Placebos can also be incorporated in the study to take into account the effect of caffeine perception on pulse-rate. Furthermore, many replicates of the experiment could be conducted under these design, which could help further negate the effects of blocking variables. The setting for the experiments should also be more controlled, and incentives should be provided to candidates so as to make sure they stick to the instructions to allow for better quality of readings. Lastly, the health and well-being of participants should be of utmost importance. Studies like [Meredith SE et al.](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3777290/), [Sweeney et al.](https://www.liebertpub.com/doi/10.1089/caff.2019.0020), and [Ali Samaha](https://www.sciencedirect.com/science/article/pii/S2352340919312004) have studied the effect of caffeine on physical and mental health in great depth and have found that caffeine is not just an addictive substance, but also has considerable negative impacts on stress and heart-rate. An experiment involving caffeine must be conducted carefully, with necessary precautions taken to ensure that the participants physical and mental health are kept in check and unaffected by caffeine pills.

# References

Ali Samaha and Ahmad (Al Tassi) and Najwa Yahfoufi and Maya Gebbawi and Mohammad Rached and Mirna A. Fawaz. Data on the relationship between caffeine addiction and stress among Lebanese medical students in Lebanon. Data in Brief. Vol: 28. pp: 104845. doi: https://doi.org/10.1016/j.dib.2019.104845.

Farag, Noha H. and Whitsett, Thomas L. and McKey, Barbara S. and Wilson, Michael F. and Vincent, Andrea S. and Everson-Rose, Susan A. and Lovallo, William R. Caffeine and Blood Pressure Response: Sex, Age, and Hormonal Status. Journal of Women's Health. Vol 19:6. pp: 1171-1176. doi: 10.1089/jwh.2009.1664. 

Gonzaga LA, Vanderlei LCM, Gomes RL, Valenti VE. Caffeine affects autonomic control of heart rate and blood pressure recovery after aerobic exercise in young adults: a crossover study. Sci Rep. 2017 Oct 26;7(1):14091. doi: 10.1038/s41598-017-14540-4. PMID: 29075019; PMCID: PMC5658389.

Karapetian GK, Engels HJ, Gretebeck KA, Gretebeck RJ. Effect of caffeine on LT, VT and HRVT. Int J Sports Med. 2012 Jul;33(7):507-13. doi: 10.1055/s-0032-1301904. Epub 2012 Apr 12. PMID: 22499570.

Meredith SE, Juliano LM, Hughes JR, Griffiths RR. Caffeine Use Disorder: A Comprehensive Review and Research Agenda. J Caffeine Res. 2013 Sep;3(3):114-130. doi: 10.1089/jcr.2013.0016. PMID: 24761279; PMCID: PMC3777290.

Sweeney, Mary M. and Weaver, Darian C. and Vincent, Kathryn B. and Arria, Amelia M. and Griffiths, Roland R. Prevalence and Correlates of Caffeine Use Disorder Symptoms Among a United States Sample. Journal of Caffeine and Adenosine Research. Vol 10:1. pp: 4-11. doi: 10.1089/caff.2019.0020.

Valentina Rakic  and Valerie Burke  and Lawrence J. Beilin. Effects of Coffee on Ambulatory Blood Pressure in Older Men and Women. Hypertension. Vol 33:3. pp: 869-873. doi: 10.1161/01.HYP.33.3.869.


# Appendix

**Data for [Participant 1 [50 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 2 [200 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 3 [100 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 1 [100 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 2 [50 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```


**Data for [Participant 3 [200 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 1 [200 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 2 [100 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```

**Data for [Participant 3 [50 mg]]**

```{r, echo = F}
reactable(data_13, showSortable = TRUE, defaultPageSize = 25, wrap  = FALSE, bordered = TRUE, pagination = TRUE, highlight = TRUE, height = 250)
```